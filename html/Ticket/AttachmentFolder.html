<& /Elements/Header, Title => loc('Attachment folder') &>
<& /Elements/Tabs &>


<table class="display" width="100%" style="width: 100%;" cellspacing="10" cellpadding="10">
	<tr>
		<td width="40%" style="40%" valign="top">
<&| /Widgets/TitleBox, title => loc('Folders') &>
<div style="width: 100%; padding: 3px; margin: 3px;">
	<input type="checkbox" id="show-nofolder"><label for="show-nofolder"><&|/l&>Show attachments without folders</&></label>
	<button id="show-all"><&|/l&>Show all</&></button>
	<input type="hidden" id="show-1" >
	<input type="hidden" id="filter-node" >
</div>

<div class="folder-container" style="max-height:550px; width:100%; border-right:1px solid silver; margin-top:3px; overflow:auto; padding: 5px;">
%foreach my $folder (@json_tree) {
	<div style="width: 100%; padding: 3px; margin: 3px;" id="<%$folder->{id}%>">
		<span class="folder-item" style="padding-left:<%(20 * ($folder->{level}-1))%>px; vertical-align: middle; cursor:pointer;">
			<img src="<%RT->Config->Get('WebPath')%>/static/images/icons8-folder-16.png" width="16" height="16">
			<%$folder->{text}%>
		</span>
		<span>

		</span>
	</div>
%}
</div>

</&>		
		</td>
		<td width="60%"  style="60%"  valign="top">
<&| /Widgets/TitleBox, title => loc('Attachments') &>
<div style="width: 100%;" class="att-containder">
	<table class="display" id="att-table" style="width: 100%;">
		<thead>
			<tr>
				<th></th>
				<th style="width: 300px;"><&|/l&>Filename</&></th>
				<th style="width: 175px;"><&|/l&>Created</&></th>
				<th style="width: 100px;"><&|/l&>User</&></th>
				<th style="width: 75px;"><&|/l&>Size</&></th>
				<th style="width: 75px;"><&|/l&>Folder</&></th>
				<th style="width: 100px;"><&|/l&>Project</&></th>
				<th style="width: 450px;"><&|/l&>Queue</&></th>
				<th style="width: 450px;"><&|/l&>Subject</&></th>
				<th style="width: 600px;"><&|/l&>Comment</&></th>
			</tr>
		</thead>
		<tfoot>
			<tr>
				<th></th>
				<th style="width: 300px;"><&|/l&>Filename</&></th>
				<th style="width: 175px;"><&|/l&>Created</&></th>
				<th style="width: 100px;"><&|/l&>User</&></th>
				<th style="width: 75px;"><&|/l&>Size</&></th>
				<th style="width: 75px;"><&|/l&>Folder</&></th>
				<th style="width: 100px;"><&|/l&>Project</&></th>
				<th style="width: 450px;"><&|/l&>Queue</&></th>
				<th style="width: 450px;"><&|/l&>Subject</&></th>
				<th style="width: 600px;"><&|/l&>Comment</&></th>
			</tr>
		</tfoot>

	</table>
</div>

</&>		

		</td>
	</tr>

</table>

<script src="<%$RT::WebPath%>/NoAuth/js/jquery.dataTables.min.js" type="text/javascript"></script>
<script type="text/javascript" src="<%RT->Config->Get('WebPath')%>/NoAuth/js/dataTables.responsive.min.js"></script>

<script type="text/javascript">
%##print "var data = $json;\n";
var filter_left = "";
var filter_right = "";
var filter = filter_left + "|" + filter_right;

jQuery(function ($) {

    $(document).ready( function() {
	    var table = $('#att-table')
	    	.addClass( 'nowrap' )
	    	.DataTable( {
%print "\t\t\t\tdata:$json,\n";
				responsive: true,
				language: {
					processing:     "Feldolgozás...",
					search:         "Keresés:",
					lengthMenu:    "_MENU_ találat oldalanként",
					info:           "Találatok: _START_ - _END_ Összesen: _TOTAL_",
					infoEmpty:      "Nulla találat",
					infoFiltered:   "(_MAX_ összes rekord közül szűrve)",
					infoPostFix:    "",
					loadingRecords: "Betöltés....",
					zeroRecords:    "Nincs a keresésnek megfelelő találat",
					emptyTable:     "A táblázatban nem állnak rendelkezésre adatok",
					paginate: {
						first:      "Első",
						previous:   "Előző",
						next:       "Következő",
						last:       "Utolsó"
					},
					aria: {
						sortAscending:  ": aktiválja a növekvő rendezéshez",
						sortDescending: ": aktiválja a csökkenő rendezéshez"
					},
					select: {
						rows: {
							"_": "%d sor kiválasztva",
							"0": "",
							"1": "1 sor kiválasztva"
						}
					},
					buttons: {
						print: "Nyomtatás",
						colvis: "Oszlopok",
						copy: "Másolás",
						copyTitle: "Vágólapra másolás",
						copySuccess: {
							"_": "%d sor másolva",
							"1": "1 sor másolva"
						}
					}
				},
		        columns : [
					{ "data" : "cat" },
					{ "data" : "file" },
					{ "data" : "date" },
					{ "data" : "user" },
					{ "data" : "size" },
					{ "data" : "node" ,
                        "fnCreatedCell": function (nTd, sData, oData, iRow, iCol) {
                            if ( oData.node ) {
                                $(nTd).html("<span>"+oData.nodenm+"</span>");
                            }
                        }
					},
					{ "data" : "proj" },
					{ "data" : "queue" },
					{ "data" : "subj" },
					{ "data" : "rem" }
		        ]
    		} ) ;

		$( ".folder-item" ).click( function() {
			$("#filter-node").val( $( this ).parent().attr( 'id' ) );
			var rx =  '^' + $( this ).parent().attr( 'id' ) + '$';
			table.columns(5).search(rx, true, false).draw();
		});

		$("#show-nofolder").click ( function() {
			$("#show-1").val( $("#show-nofolder").prop("checked") );
			if($("#show-nofolder").prop("checked")) {   
				table.columns(5).search("-1", true, false).draw();
			} else {
				//table.columns(5).search("^(?:(?!-1).)*$\r?\n?", true, false).draw();
				table.columns(5).search("nothing", true, false).draw();
			}
		} );

		$("#show-all").click ( function() {
			table.columns().search('').draw(); 
		} );


		table.columns(5).search("nothing", true, false).draw();



    } );




} );


function countTypesForNode(resultArray, nodeVal) {
   var i,
       types,
       count = 0;
   for (i=0, types = {}; i < resultArray.length; i++)
      if (resultArray[i].bulan === nodeVal && !types[resultArray[i].type]) {
         types[resultArray[i].type] = true;
         count++;
      }
   return count;
}



</script>




<%INIT>
use utf8;
use JSON;
use Data::Dumper;
use YAML::Tiny;
use Try::Tiny;

my $json = LoadTicketsWithAttachments( $id );
my $folders = LoadListFromTransaction( LoadQFCConfig ($id) );
my @json_tree = @{decode_json( "[$folders]" )};
###
#
###

sub LoadTicketsWithAttachments {
	my $id = shift;
	my $Ticket = RT::Ticket->new( $session{'CurrentUser'} );
	$Ticket->Load( $id );
	my $Queue = $Ticket->QueueObj->Name;
	my $QueueObj = $Ticket->QueueObj;

	##my $config = LoadStarterTicket( $id );
	my $folders = LoadListFromTransaction( LoadQFCConfig ($id) ) || "" ;

	my $TicketSet = RT::Tickets->new( RT::SystemUser );
## ( 'QueueCF.{Q-CRM kód}' = 'Teszt234' OR 'QueueCF.{Q-Projekt kód}' = 'Teszt234' OR 'CF.{Ajánlatszám/munkaszám}' = 'Teszt234' OR 'CF.{Ajánlatszám/munkaszám}' = 'Teszt234' ) AND (  Status = 'new' OR Status = 'open' OR Status = 'stalled' )
## ('QueueCF.{Q-Projekt kód}' = '$text_to_search' OR 'CF.{Ajánlatszám/munkaszám}' = '$text_to_search')
	my $q_crm_code = $QueueObj->FirstCustomFieldValue( 'Q-CRM kód' ) || $QueueObj->FirstCustomFieldValue( 'Q-Projekt kód' ) || $Ticket->FirstCustomFieldValue( 'Projekt kód' ) || $Ticket->FirstCustomFieldValue( 'CRM kód' );
	my $q_project_code = $QueueObj->FirstCustomFieldValue( 'Q-Projekt kód' ) || $QueueObj->FirstCustomFieldValue( 'Q-CRM kód' ) || $Ticket->FirstCustomFieldValue( 'Projekt kód' ) || $Ticket->FirstCustomFieldValue( 'CRM kód' );
	my $crm_code = $Ticket->FirstCustomFieldValue( 'CRM kód' ) || $Ticket->FirstCustomFieldValue( 'Projekt kód' )  || $q_crm_code || $q_project_code;
	my $project_code = $Ticket->FirstCustomFieldValue( 'Projekt kód' ) || $Ticket->FirstCustomFieldValue( 'CRM kód' )  || $q_project_code || $q_crm_code;

	my(%row, @json);

	my %colormap = RT->Config->Get('AttachmentCategories');

####	'CF.{Projekt kód}' LIKE 'LONDON'	
####   "('QueueCF.{Q-CRM kód}' = '$crm' OR 'QueueCF.{Q-Projekt kód}' = '$crm' OR 'CF.{Ajánlatszám/munkaszám}' = '$crm' OR 'CF.{Ajánlatszám/munkaszám}' = '$crm')"
####	('CF.{Sepland}' = '$crm' OR 'CF.{Munkaszám}' = '$crm')
	my $SQL = sprintf(RT->Config->Get('Scope'), $id, $Queue);
####	my $SQL =   "(id = $id OR Queue = '$Queue') AND (Status = '__Active__' OR Status = '__Inactive__')";
	RT::Logger->info("### \n LoadTicketsWithAttachments->SQL = $SQL \n ###");
	$TicketSet->FromSQL( $SQL );
	my $cnt = $TicketSet->Count;
##	$TicketSet->FromSQL( "( Status = 'new' OR Status = 'open' OR Status = 'stalled' ) AND Queue = '$Queue'" );
	my $i = 0;
	while ( my $T = $TicketSet->Next() ) {
		my $Attachments = $T->Attachments;
		$Attachments = $Attachments->Clone;
		$Attachments->LimitHasFilename;
		if ($Attachments->Count > 0) {
			my $subj = $T->Subject;
			RT::Logger->info( sprintf("id=%d, subj=%s, in queue=%s", $T->Id, $T->Subject, $T->QueueObj->Name) );
			my $json_folders = decode_json( "[$folders]" ) if ( $folders );
			while ( my $Attachment = $Attachments->Next() ) {
				next if ($Attachment->Filename =~ /_rr\.(jpg|jpeg|png)/i);
				my $Att = $Attachment->Filename;
				
				my $Category = ($Attachment->FirstAttribute('Category')?$Attachment->FirstAttribute('Category')->Content:'X');
				my $Folder = ($Attachment->FirstAttribute('Folder')?$Attachment->FirstAttribute('Folder')->Content:'-1');
				my $path = '';
				unless ($Attachment->ContentType eq 'text/uri-list') {
					$path = RT->Config->Get('WebPath').'/Ticket/Attachment/'.$Attachment->TransactionId.'/'.$Attachment->Id;
				} else {
					$path = $Attachment->Content;
				};
				unless ($Attachment->ContentType eq 'text/uri-list') {
					$row{ 'file' } = "<a href='$path/$Att' target='_blank'>$Att</a>"; 
				} else {
					$row{ 'file' } = "<a href='$path' target='_blank'>$Att</a>";
				}
				$row{ 'file' } .= '<br /><span style="font-style: oblique; font-color: #EEE">' . $Attachment->FirstAttribute('Comment')->Content . '</span>' if ($Attachment->FirstAttribute('Comment'));
				$row{ 'date' } = $Attachment->CreatedAsString;
				$row{ 'user' } = $Attachment->CreatorObj->Name;
				my $filesize = $Attachment->ContentLength;
				$row{ 'size' } = $filesize > 1024 ? sprintf( '%.1f Kb', $filesize/1024 ) : sprintf( '%d b', $filesize );
				$row{ 'node' } = $Folder;
				unless( $folders && $Folder ) {
					$row{ 'nodenm' } = " - ";
				} else {
					try {
						$row{ 'nodenm' } = (grep $_->{id} eq $Folder, @{ $json_folders } )[0]{text};	
					} catch {
						$row{ 'nodenm' } = " - ";
					}
				};
				$row{ 'cat' } = "<div style='width:15px; height:15px; background-color: $colormap{$Category}'></div>"; ##   $Category;
				$row{ 'rem' } = $Attachment->FirstAttribute('Comment')?$Attachment->FirstAttribute('Comment')->Content:'';
				$row{ 'queue' } = $T->QueueObj->Name;
				my $link = RT->Config->Get('WebPath') . '/Ticket/Display.html?id=' . $T->id;
				$row{ 'subj' } =  "<a href='$link' target='_blank'>$subj</a>"  ;
				$row{ 'proj' } = $project_code;
				push @json, {%row};
			}
		}
	}

	return Encode::decode_utf8( encode_json (\@json) );
}

sub LoadQFCConfig {
	my $id = shift;
	my $Ticket = RT::Ticket->new( RT::SystemUser );
	$Ticket->Load( $id );
	my $Queue = $Ticket->QueueObj;

	my $ConfigTikcetSubject = $Queue->FirstCustomFieldValue('Q-FolderStruktura') if ($Queue->FirstCustomFieldValue('Q-FolderStruktura'));

	unless ($ConfigTikcetSubject) {
		my $__id = RT->Config->Get('DefaultFolderStructureTicketID');
		my $FolderStructureTicket = RT::Ticket->new( RT::SystemUser );
		RT::Logger->info("ShowAttachments __id = $__id");
		$FolderStructureTicket->Load(RT->Config->Get('DefaultFolderStructureTicketID'));
		$ConfigTikcetSubject = $FolderStructureTicket->Subject;
	}

	if ($ConfigTikcetSubject) {
		my $Tickets = RT::Tickets->new( RT::SystemUser );
		$Tickets->FromSQL( "Queue = 'Lista: Alapdokumentum' AND Status = '__Active__' AND Subject LIKE '$ConfigTikcetSubject'" ) ;
		return $Tickets->First()->Id;
	}
	return 0 ;
}

sub LoadStarterTicket {
	my $id = shift;		# Starer ticket id

	### $RT::Logger->info("LoadStarterTicket!id = $id");

	my $yaml;
	my ($StartTicketObj, $StartQueueObj, $StartCustomFieldContent);

	my $TicketObj = RT::Ticket->new($RT::SystemUser);
	$TicketObj->Load($id);

	my $QueueObj = $TicketObj->QueueObj;

	$StartTicketObj = RT::Ticket->new($RT::SystemUser);
	
	my $StarterID = $QueueObj->FirstCustomFieldValue( 'Q-StarterConfigTicketId' ) if ($QueueObj->FirstCustomFieldValue( 'Q-StarterConfigTicketId' ));

	### $RT::Logger->info("LoadStarterTicket!StarterID = $StarterID");
	
	if ( $StarterID ) {
		$StartTicketObj->Load( $StarterID );

		$StartCustomFieldContent = $StartTicketObj->FirstCustomFieldValue(RT->Config->Get('TextJegyzet'));
		# Create a new object with a single hashref document
		try {
			$yaml = YAML::Tiny->read_string( $StartCustomFieldContent );
			return $yaml->[0];
		} catch {
			return 0;
		}
	} else {
		return 0;
	}
}

sub LoadListFromTransaction {
	my $ticketID = shift;

	### $RT::Logger->info("LoadListFromTransaction!ticketID = $ticketID");

	my $Ticket = RT::Ticket->new( RT::SystemUser );
	$Ticket->Load($ticketID);

	##
	#  Loaded ticket last comment => editor
	##

	my $message = $Ticket->FirstCustomFieldValue('TextJegyzet') if ( $Ticket->FirstCustomFieldValue('TextJegyzet') );
	if ($message) {
		my @csv_lines = split /^/m, $message;
		my $json_text = '';
		foreach my $line (@csv_lines) {
			chomp($line);
			my ($level, $id, $node) = split ';', $line;
			$json_text .= "{ \"id\": \"$id\", \"text\": \"$node\", \"level\": \"$level\" },";
		}
		chop($json_text);
		return Encode::encode_utf8($json_text);
	} else { 
		return undef;
	}
}
</%INIT>

<%ARGS>
$id => undef
</%ARGS>
